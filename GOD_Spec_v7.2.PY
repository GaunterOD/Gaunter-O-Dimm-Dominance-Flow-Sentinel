import ccxt
import pandas as pd
import numpy as np
import time
import os
import sys
import requests
from datetime import datetime

# ==========================================
# 1. í™”ë©´ ì„¤ì • & ë¡œê³ 
# ==========================================
def clear_screen():
    os.system('cls' if os.name == 'nt' else 'clear')

def print_banner_simple():
    clear_screen()
    print("  ____                    _             ")
    print(" / ___| __ _ _   _ _ __ | |_ ___ _ __ ")
    print("| |  _ / _` | | | | '_ \| __/ _ \ '__|")
    print("| |_| | (_| | |_| | | | | ||  __/ |   ")
    print(" \____|\__,_|\__,_|_| |_|\__\___|_|   ")
    print("                                      ")
    print(" ======================================================")
    print("    GAUNTER-O-DIMM Trend Follower Spec v7.2 (Final)")
    print("             Designed by [ GAUNTER-O-DIMM ]              ")
    print(" ------------------------------------------------------")
    print("  Supported: 1m, 3m, 5m, 15m, 30m, 1h, 4h, 1d, 1w, 1M  ")
    print("  Control  : Press [ Ctrl + C ] to Stop / Back         ")
    print(" ======================================================\n")

# ==========================================
# 1.5. ê¸€ë¡œë²Œ ë§ˆì¼“ ê°ì‹œ (ë„ë¯¸ë„ŒìŠ¤ & í˜ê¹… & ì¶”ì„¸)
# ==========================================
def get_global_market_status():
    try:
        # 1. ê°€ê²© (Coinbase)
        usdt_price = float(requests.get("https://api.coinbase.com/v2/prices/USDT-USD/spot").json()['data']['amount'])
        
        # 2. ê¸€ë¡œë²Œ ë°ì´í„° & ê°œë³„ ì½”ì¸ ë°ì´í„° (CoinGecko)
        # ë„ë¯¸ë„ŒìŠ¤ ë³€í™”ëŸ‰ì„ ê³„ì‚°í•˜ê¸° ìœ„í•´ 24h ë³€ë™ë¥  ë°ì´í„°ê°€ í•„ìš”í•¨
        global_resp = requests.get("https://api.coingecko.com/api/v3/global", timeout=5).json()['data']
        
        # ë¹„íŠ¸ì½”ì¸ê³¼ í…Œë”ì˜ 24ì‹œê°„ ë³€ë™ë¥  ê°€ì ¸ì˜¤ê¸° (ë„ë¯¸ë„ŒìŠ¤ ì—­ì‚°ìš©)
        coins_resp = requests.get(
            "https://api.coingecko.com/api/v3/coins/markets?vs_currency=usd&ids=bitcoin,tether&price_change_percentage=24h", 
            timeout=5
        ).json()
        
        btc_data = next(item for item in coins_resp if item['id'] == 'bitcoin')
        usdt_data = next(item for item in coins_resp if item['id'] == 'tether')

        # í˜„ì¬ ë„ë¯¸ë„ŒìŠ¤
        cur_btc_dom = global_resp['market_cap_percentage']['btc']
        cur_usdt_dom = global_resp['market_cap_percentage'].get('usdt', 0)

        # [ë„ë¯¸ë„ŒìŠ¤ ë³€í™”ëŸ‰ ì—­ì‚° ë¡œì§]
        # ê³µì‹: ì–´ì œ_ë„ë¯¸ = í˜„ì¬_ë„ë¯¸ * ((1 + ì „ì²´ì‹œì´ë³€ë™ë¥ ) / (1 + ì½”ì¸ì‹œì´ë³€ë™ë¥ ))
        total_chg = global_resp['market_cap_change_percentage_24h_usd'] / 100
        btc_chg_rate = btc_data['market_cap_change_percentage_24h'] / 100
        usdt_chg_rate = usdt_data['market_cap_change_percentage_24h'] / 100

        prev_btc_dom = cur_btc_dom * ((1 + total_chg) / (1 + btc_chg_rate))
        prev_usdt_dom = cur_usdt_dom * ((1 + total_chg) / (1 + usdt_chg_rate))

        btc_dom_delta = cur_btc_dom - prev_btc_dom
        usdt_dom_delta = cur_usdt_dom - prev_usdt_dom

        # [3] í…Œë” í˜ê¹… ìƒíƒœ ë©”ì‹œì§€ ê²°ì •
        # ê°€ê²©ì€ ë¬´ì¡°ê±´ ë³´ì—¬ì£¼ê³ , ìƒíƒœ ë©”ì‹œì§€ë§Œ ì—¬ê¸°ì„œ ì •í•¨
        if usdt_price >= 1.0005: 
            peg_msg = "ğŸ”´í”„ë¦¬ë¯¸ì—„ (ì£¼ì˜)" 
        elif usdt_price <= 0.9995: 
            peg_msg = "ğŸ”µì´íƒˆìš°ë ¤ (ì£¼ì˜)"
        else:
            peg_msg = "ğŸŸ¢ì•ˆì •"

        return {
            "btc_dom": cur_btc_dom,
            "btc_delta": btc_dom_delta,
            "usdt_dom": cur_usdt_dom,
            "usdt_delta": usdt_dom_delta,
            "usdt_price": usdt_price,
            "peg_msg": peg_msg
        }

    except Exception as e:
        # ì—ëŸ¬ ë°œìƒ ì‹œ None ë¦¬í„´ (ë©”ì¸ ë£¨í”„ì—ì„œ ë¬´ì‹œ)
        return None

# ==========================================
# 2. ì‚¬ìš©ì ë©”ë‰´
# ==========================================
def main_menu():
    print_banner_simple()
    print(" [ ë©”ì¸ ì»¨íŠ¸ë¡¤ ì„¼í„° ]\n")
    print(" 1. Binance (ë°”ì´ë‚¸ìŠ¤) - BTC/USDT")
    print(" 2. Coinbase (ì½”ì¸ë² ì´ìŠ¤) - BTC/USD")
    print(" Q. ì‹œìŠ¤í…œ ì¢…ë£Œ")
    
    choice = input("\n >> ê±°ë˜ì†Œë¥¼ ì„ íƒí•´ (1/2/Q): ").strip().upper()
    
    if choice == 'Q':
        sys.exit()
    
    options = {'enableRateLimit': True, 'timeout': 15000}

    if choice == '1':
        exchange = ccxt.binance(options)
        symbol = 'BTC/USDT'
        ex_name = 'Binance'
        try:
            exchange.hosts = ['api.binance.com', 'api1.binance.com', 'api2.binance.com', 'api3.binance.com']
        except:
            pass
    elif choice == '2':
        exchange = ccxt.coinbase(options)
        symbol = 'BTC/USD'
        ex_name = 'Coinbase'
    else:
        return None, None, None, None

    
    print(" [ì§€ì› ì‹œê°„ë´‰: 1m, 3m, 5m, 15m, 30m, 1h, 2h, 4h, 6h, 8h, 12h, 1d, 3d, 1w, 1M]")
    
    raw_input = input(" >> ì‹œê°„ë´‰ ì…ë ¥ (ê¸°ë³¸ê°’ 15m): ")
    timeframe = raw_input.strip().lower()
    if not timeframe: timeframe = '15m'
        
    return exchange, ex_name, symbol, timeframe



def detect_sr_flip(df, window=5, tolerance=0.01):
    """
    df: ì°¨íŠ¸ ë°ì´í„° (timestamp ì»¬ëŸ¼ í•„ìˆ˜)
    window: ì¢Œìš° ë¹„êµ ë²”ìœ„
    tolerance: ì˜¤ì°¨ ë²”ìœ„ ë¹„ìœ¨
    """
    current_price = df['close'].iloc[-1]
    
    # ìµœê·¼ 1000ê°œ ë°ì´í„°ë§Œ ì‚¬ìš© (ì†ë„ ë° ìµœì‹ ì„± ê³ ë ¤)
    subset = df.iloc[:-1].copy() 
    
    potential_pivots = [] # (ê°€ê²©, íƒ€ì…, ë‚ ì§œ)ë¥¼ ì €ì¥í•  ë¦¬ìŠ¤íŠ¸

    # í”¼ë²— í¬ì¸íŠ¸ ì°¾ê¸°
    for i in range(window, len(subset) - window):
        price = subset['close'].iloc[i]
        date_time = subset['timestamp'].iloc[i] # íƒ€ì„ìŠ¤íƒ¬í”„ ê°€ì ¸ì˜¤ê¸°
        
        # ê³ ì  íŒë³„
        is_high = all(subset['high'].iloc[i] >= subset['high'].iloc[i-k] for k in range(1, window+1)) and \
                  all(subset['high'].iloc[i] >= subset['high'].iloc[i+k] for k in range(1, window+1))
        
        # ì €ì  íŒë³„
        is_low = all(subset['low'].iloc[i] <= subset['low'].iloc[i-k] for k in range(1, window+1)) and \
                 all(subset['low'].iloc[i] <= subset['low'].iloc[i+k] for k in range(1, window+1))

        if is_high:
            potential_pivots.append((subset['high'].iloc[i], "RES", date_time))
        if is_low:
            potential_pivots.append((subset['low'].iloc[i], "SUP", date_time))

    # [3] í´ëŸ¬ìŠ¤í„°ë§ (ë¹„ìŠ·í•œ ê°€ê²©ëŒ€ ë­‰ì¹˜ê¸°) & í•„í„°ë§
    zones = []
    
    for p_price, p_type, p_time in reversed(potential_pivots):
        # ê¸°ì¡´ ì¡´ë“¤ê³¼ ë¹„êµ
        is_grouped = False
        for i, (z_price, z_count, z_type, z_time) in enumerate(zones):
            # ê¸°ì¡´ ì¡´ ê°€ê²©ì˜ ì˜¤ì°¨ë²”ìœ„ ë‚´ì— ìˆë‹¤ë©´ ê°™ì€ ì¡´ìœ¼ë¡œ ì·¨ê¸‰ (íšŸìˆ˜ ì¦ê°€)
            if z_price * (1 - tolerance) <= p_price <= z_price * (1 + tolerance):
                # ê°€ê²©ì„ í‰ê· ë‚´ì„œ ì—…ë°ì´íŠ¸ (ë” ì •í™•í•´ì§)
                new_avg = (z_price * z_count + p_price) / (z_count + 1)
                zones[i] = (new_avg, z_count + 1, z_type, p_time) # ì‹œê°„ì€ ìµœì‹ ê±¸ë¡œ
                is_grouped = True
                break
        
        if not is_grouped:
            zones.append((p_price, 1, p_type, p_time)) # (ê°€ê²©, í„°ì¹˜íšŸìˆ˜, íƒ€ì…, ì‹œê°„)

    # [4] í˜„ì¬ê°€ ê¸°ì¤€ ê°€ê¹Œìš´ ìˆœì„œë¡œ ì •ë ¬ ë° ì„ ë³„
    valid_zones = []
    
    for z_price, z_count, z_type, z_time in zones:
        # ì¡°ê±´: 2ë²ˆ ì´ìƒ ì§€ì§€/ì €í•­ ë°›ì•˜ê±°ë‚˜, ìµœê·¼ì— ìƒê¸´ ì™¸ë°”ë‹¥/ì™¸ë´‰ì¼ ê²½ìš°
        if z_count >= 2: 
            valid_zones.append({'price': z_price, 'count': z_count, 'type': z_type})

    # í˜„ì¬ê°€ì™€ ê±°ë¦¬ ê³„ì‚°í•´ì„œ ì •ë ¬
    valid_zones.sort(key=lambda x: abs(x['price'] - current_price))

    # ê°€ì¥ ê°€ê¹Œìš´ 3ê°œë§Œ ë¦¬í„´
    return valid_zones[:3] if valid_zones else None


# [ìˆ˜ì •ë¨] ë°ì´í„° ì²˜ë¦¬
def fetch_and_process(exchange, symbol, timeframe):
    try:
        ohlcv = exchange.fetch_ohlcv(symbol, timeframe, limit=1000)
        
        if not ohlcv or len(ohlcv) < 200:
            return None, None, "ë°ì´í„° ë¶€ì¡±" 
            
        df = pd.DataFrame(ohlcv, columns=['timestamp', 'open', 'high', 'low', 'close', 'volume'])
        
        # (1) ì´í‰ì„ 
        df['EMA_55'] = df['close'].ewm(span=55, adjust=False).mean()
        df['EMA_200'] = df['close'].ewm(span=200, adjust=False).mean()
        
        # (2) ì´ê²©ë„
        df['Disp_Price_55'] = (df['close'] / df['EMA_55']) * 100
        df['Disp_55_200'] = (df['EMA_55'] / df['EMA_200']) * 100
        
        # (3) RSI
        delta = df['close'].diff()
        gain = (delta.where(delta > 0, 0)).rolling(window=14).mean()
        loss = (-delta.where(delta < 0, 0)).rolling(window=14).mean()
        rs = gain / loss
        df['RSI'] = 100 - (100 / (1 + rs))
        
        # (4) Volume Delta & Slope
        df['Vol_Delta'] = np.where(df['close'] > df['open'], df['volume'], -df['volume'])
        df['EMA_55_Slope'] = df['EMA_55'].diff()

        # [NEW] íƒ€ì„í”„ë ˆì„ë³„ ë™ì  ì„¤ì • (Dynamic Settings)
        if timeframe in ['1m', '3m', '5m', '15m']:
            set_window = 10       
            set_tol = 0.003       
        elif timeframe in ['30m', '1h', '4h']:
            set_window = 15
            set_tol = 0.005       
        elif timeframe in ['1d', '3d']:
            set_window = 20
            set_tol = 0.01        
        else: # 1w, 1M ë“±
            set_window = 30       
            set_tol = 0.02        

        # í•¨ìˆ˜ í˜¸ì¶œ ì‹œ ì„¤ì •ê°’ ì „ë‹¬ (ê²°ê³¼ê°’ ë³€ìˆ˜ëª…ë„ ë¦¬ìŠ¤íŠ¸ì„ì„ ëª…ì‹œí•˜ê¸° ìœ„í•´ ë³€ê²½)
        sr_lines = detect_sr_flip(df, window=set_window, tolerance=set_tol)
        
        return df, sr_lines, None

    except Exception as e:
        return None, None, str(e)

# ==========================================
# 4. ëª¨ë‹ˆí„°ë§ & íŒì •
# ==========================================
def format_delta(val):
    """ë³€í™”ëŸ‰ì— ë”°ë¼ í™”ì‚´í‘œì™€ ìƒ‰ìƒ(í…ìŠ¤íŠ¸) ë¦¬í„´"""
    if val > 0: return f"â–² {abs(val):.2f}%"
    elif val < 0: return f"â–¼ {abs(val):.2f}%"
    else: return "- 0.00%"

def run_monitor(exchange, ex_name, symbol, timeframe):
    print(f"\n >>> {ex_name} ë°ì´í„° ë¡œë”© ì¤‘... (ìµœëŒ€ 1000ë´‰)")
    
    g_data = None

    while True:
        try:
            print(".", end="", flush=True)

            # [1] ê¸€ë¡œë²Œ ë°ì´í„°
            try:
                temp_g_data = get_global_market_status()
                if temp_g_data:
                    g_data = temp_g_data
            except Exception:
                pass 

            # [2] ì°¨íŠ¸ ë°ì´í„°
            df, sr_msg, error_msg = fetch_and_process(exchange, symbol, timeframe)
            
            if df is not None:
                print_banner_simple()

                # [3] ê¸€ë¡œë²Œ ì •ë³´
                if g_data:
                    print(f" [ ğŸŒ GLOBAL MARKET VIEW ]")
                    print(f"  â–  BTC.D : {g_data['btc_dom']:.2f}% ({format_delta(g_data['btc_delta'])})")
                    print(f"  â–  USDT.D: {g_data['usdt_dom']:.2f}% ({format_delta(g_data['usdt_delta'])})")
                    print(f"  â–  USDT  : ${g_data['usdt_price']:.4f}  {g_data['peg_msg']}")
                    print(" =" * 60 + "\n")

                curr = df.iloc[-1]
                
                # --- [íŒë‹¨ ë¡œì§] ---
                is_golden_cross = curr['EMA_55'] > curr['EMA_200']
                trend_up = (curr['close'] > curr['EMA_55']) and (curr['EMA_55_Slope'] > 0)
                
                # (1) ì´ê²©ë„ ì •ë°€ ë¶„ì„
                gap_p_55 = curr['Disp_Price_55'] - 100
                if gap_p_55 >= 5.0: 
                    p_status, p_comment = "ğŸ”´ê³¼ë§¤ìˆ˜", "ì´ê²© ê³¼ë‹¤! ë˜ëŒë¦¼ ì£¼ì˜"
                elif gap_p_55 <= -5.0:
                    p_status, p_comment = "ğŸ”µê³¼ë§¤ë„", "ì´ê²© ê³¼ë‹¤! ê¸°ìˆ ì  ë°˜ë“± ê°€ëŠ¥ì„±"
                elif gap_p_55 > 0:
                    p_status, p_comment = "ğŸ“ˆìƒìŠ¹ ìœ ì§€", "55ì„  ìœ„ ì§€ì§€ ì¤‘"
                else:
                    p_status, p_comment = "ğŸ“‰í•˜ë½ ìœ ì§€", "55ì„  ì•„ë˜ ì €í•­ ì¤‘"

                # (2) 55-200 ì´ê²©ë„
                gap_55_200 = curr['Disp_55_200'] - 100
                if gap_55_200 >= 10.0:
                    t_status, t_comment = "ğŸš€ë‹¨ê¸° ê³¼ì—´", "ê°„ê²© ë„ˆë¬´ ë„“ìŒ (ì¡°ì • ì£¼ì˜)"
                elif gap_55_200 <= -10.0:
                    t_status, t_comment = "ğŸ’€ë‹¨ê¸° ì¹¨ì²´", "ê°„ê²© ë„ˆë¬´ ë„“ìŒ (ë°˜ë“± ì£¼ì˜)"
                elif gap_55_200 > 0:
                    t_status, t_comment = "âœ¨ì •ë°°ì—´", "ì´ìƒì ì¸ í™•ì‚° ì¤‘"
                else:
                    t_status, t_comment = "ğŸŒ§ï¸ì—­ë°°ì—´", "í•˜ë½ í˜ì´ ê°•í•¨"

                # (3) RSI ì •ë°€ ë¶„ì„ (ì§€ì†ì„± ì¹´ìš´íŒ…) [NEW]
                rsi_val = curr['RSI']
                if rsi_val >= 70: rsi_status = "ğŸ”¥ê³¼ë§¤ìˆ˜ êµ¬ê°„ (70â†‘)"
                elif rsi_val <= 30: rsi_status = "ğŸ’§ê³¼ë§¤ë„ êµ¬ê°„ (30â†“)"
                elif rsi_val >= 50: rsi_status = "âœ¨ê°•ì„¸ êµ¬ê°„ (Bull)"
                else: rsi_status = "ğŸŒ‘ì•½ì„¸ êµ¬ê°„ (Bear)"

                # [NEW] RSI 50ì„  ê¸°ì¤€ ì§€ì†ì„± ì¹´ìš´íŒ… ë¡œì§
                rsi_series = df['RSI'].values
                current_is_bull = rsi_val >= 50
                rsi_duration = 0
                
                # ì—­ìˆœìœ¼ë¡œ ì¶”ì í•˜ì—¬ ëª‡ ë´‰ ì—°ì†ì¸ì§€ ê³„ì‚°
                for i in range(len(rsi_series) - 1, -1, -1):
                    val = rsi_series[i]
                    if current_is_bull and val >= 50:
                        rsi_duration += 1
                    elif not current_is_bull and val < 50:
                        rsi_duration += 1
                    else:
                        break # ì¶”ì„¸ê°€ ëŠê¸´ ì§€ì 
                
                # ìƒí™©ë³„ ë©”ì‹œì§€ ìƒì„±
                if rsi_duration == 1:
                    # ë°©ê¸ˆ ë§‰ ëŒíŒŒí•¨
                    action_msg = "ğŸš€ [ì•Œë¦¼] ë°©ê¸ˆ 50ì„  ëŒíŒŒ! (ì¶”ì„¸ ì „í™˜ ì‹œë„)"
                elif 3 <= rsi_duration <= 6:
                    # 3~6ë´‰ ì§€ì† (ì•ˆì°© ì‹œë„ ì¤‘)
                    action_msg = f"ğŸ‘€ [ì£¼ì‹œ] ì¶”ì„¸ êµ³íˆê¸° ì¤‘ ({rsi_duration}ë´‰ ì—°ì† ìœ ì§€)"
                elif rsi_duration > 6:
                    # ì¥ê¸° ì§€ì†
                    tag = "ğŸ”¥ìƒìŠ¹" if current_is_bull else "â„ï¸í•˜ë½"
                    action_msg = f"{tag}ì„¸ ì™„ì „ ì¥ì•… ({rsi_duration}ë´‰ ì§¸ ì§€ì† ì¤‘)"
                else:
                    # 2ë´‰ ë“± ì• ë§¤í•œ êµ¬ê°„
                    action_msg = f"ğŸ” ë°©í–¥ íƒìƒ‰ ì¤‘ ({rsi_duration}ë´‰ ì§¸)"

                
                # --- [í™”ë©´ ì¶œë ¥] ---
                print(f" [íƒ€ê²Ÿ] {ex_name} | {symbol} | {timeframe}")
                print(f" [ì‹œê°„] {datetime.now().strftime('%H:%M:%S')} (ì¢…ë£Œ: Ctrl+C)\n")
                
                print(f" ğŸ’µ í˜„ì¬ê°€        : {curr['close']:,.2f}")
                
                trend_icon = "ğŸ“ˆ ì •ë°°ì—´(ìƒìŠ¹ì¥)" if is_golden_cross else "ğŸ“‰ ì—­ë°°ì—´(í•˜ë½ì¥)"
                print(f" ğŸŒŠ ì¶”ì„¸ ì§€ë„    : {trend_icon}")
                print(f"    â”” 55ì„ : {curr['EMA_55']:,.2f} | 200ì„ : {curr['EMA_200']:,.2f}")
                
                print("-" * 60) # ì„¹ì…˜ êµ¬ë¶„ì„ 
                
                print(f" ğŸ§² ì´ê²©ë„ ë¶„ì„ (í‰ê·  íšŒê·€ ê´€ì )")
                print(f"    â‘  [í˜„ì¬ê°€ vs 55ì„ ] : {gap_p_55:+.2f}% ({p_status})")
                print(f"       â”” í•´ì„: {p_comment}")
                print()
                print(f"    â‘¡ [55ì„  vs 200ì„ ]  : {gap_55_200:+.2f}% ({t_status})")
                print(f"       â”” í•´ì„: {t_comment}")
                
                print("-" * 60) # ì„¹ì…˜ êµ¬ë¶„ì„ 
                
                vol_icon = "ë§¤ìˆ˜ì„¸ ìš°ìœ„" if curr['Vol_Delta'] > 0 else "ë§¤ë„ì„¸ ìš°ìœ„"
                print(f" ğŸ’ª ì²´ë ¥(RSI)    : {rsi_val:.2f} -> {rsi_status}")
                print(f"    â”” ì§€ì†ì„± : {action_msg}") 
                print(f" ğŸ“Š ìˆ˜ê¸‰(Vol)    : {vol_icon}")
                
                print("-" * 60) # ì„¹ì…˜ êµ¬ë¶„ì„ 
                
                print(f" ğŸ›¡ï¸ S/R ì£¼ìš”êµ¬ê°„ (ê°€ê¹Œìš´ ìˆœ)")
                if sr_msg and isinstance(sr_msg, list): 
                    for item in sr_msg:
                        p = item['price']
                        cnt = item['count']
                        diff = ((curr['close'] - p) / p) * 100
                        
                        if curr['close'] >= p:
                            pos_str = f"ğŸŸ¢ ì§€ì§€ (í•˜ë°© {abs(diff):.2f}%)"
                        else:
                            pos_str = f"ğŸ”´ ì €í•­ (ìƒë°© {abs(diff):.2f}%)"
                            
                        print(f"    â”” {pos_str} : ${p:,.0f} (í„°ì¹˜ {cnt}íšŒ)")
                else:
                    print(f"    â”” âšª í˜„ì¬ê°€ ê·¼ì²˜ì— ëšœë ·í•œ ë§¤ë¬¼ëŒ€ ì—†ìŒ")
                
                print("=" * 60) # ìµœì¢… êµ¬ë¶„ì„ 
                

                # --- [ìµœì¢… ì½”ë©˜íŠ¸: ìƒí™©ë³„ ì •ë°€ ì¡°ì–¸] ---
                print(" >>> [êµ°í„°ì˜ ì¡°ì–¸]", end=" ")
                
                # 1. ì´ê²©ë„ ê³¼ë‹¤ (ìœ„í—˜ ê²½ê³ )
                if gap_p_55 >= 7.0:
                    print("ğŸ”¥ìƒìŠ¹í­ì´ ë„ˆë¬´ ì»¤! ì§€ê¸ˆ ì‚¬ë©´ 'ê³ ì  íŒë…ê¸°' ëœë‹¤. ì¡°ì • ì˜¬ ë•Œê¹Œì§€ ì°¸ì•„.")
                elif gap_p_55 <= -7.0:
                    print("ğŸ’§ë„ˆë¬´ ë§ì´ ë¹ ì¡Œì–´. 'ê¸°ìˆ ì  ë°˜ë“±'ì´ ë‚˜ì˜¬ ìë¦¬ì•¼. ì¶”ê²© ìˆì€ ìœ„í—˜í•´.")
                
                # 2. ì¶”ì„¸ í™•ì • (ê±´ê°•í•œ íë¦„)
                elif is_golden_cross and rsi_val >= 50 and trend_up:
                    print("ğŸš€ìƒìŠ¹ ì¶”ì„¸ê°€ ì•„ì£¼ ê±´ê°•í•´! ì«„ì§€ ë§ê³  íë¦„ì— ì˜¬ë¼íƒ€. (Long ìœ ë¦¬)")
                elif not is_golden_cross and rsi_val < 50:
                    print("ğŸ“‰í•˜ë½ ì¶”ì„¸ê°€ ëª…í™•í•´. ë°˜ë“± ì‹œ ìˆì„ ë³´ê±°ë‚˜ í˜„ê¸ˆ ì¥ê³  ìˆì–´. (Short ìœ ë¦¬)")
                
                # 3. ë¹„ì¶”ì„¸/íš¡ë³´
                else:
                    print("ğŸ’¤ë°©í–¥ì´ ì• ë§¤í•´. ê³ ë˜ë“¤ì´ ì‹¸ìš°ëŠ” ì¤‘ì´ë‹ˆ ì´í‰ì„  ì •ë¦¬ë  ë•Œê¹Œì§€ êµ¬ê²½í•´.")

            else:
                print(f"\n [!!!] ì˜¤ë¥˜: {error_msg}")
                time.sleep(3)
                
            time.sleep(2)

        except KeyboardInterrupt:
            return
        except Exception as e:
            print(f"\n[Error] {e}")
            time.sleep(5)

if __name__ == "__main__":
    try:
        while True:
            exchange, ex_name, symbol, timeframe = main_menu()
            if exchange:
                run_monitor(exchange, ex_name, symbol, timeframe)
    except Exception as e:
        print(f"\n\n[í”„ë¡œê·¸ë¨ ì¢…ë£Œ] ì˜¤ë¥˜ ë°œìƒ: {e}")
        input("ì—”í„° í‚¤ë¥¼ ëˆ„ë¥´ë©´ ì¢…ë£Œí•©ë‹ˆë‹¤...")
